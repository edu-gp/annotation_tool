{% extends 'base.html' %}

{% block header %}
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{{ url_for('index') }}">Home</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        Task
      </li>
    </ol>
  </nav>
{% endblock %}

{% block content %}
  <h1>{{task}}</h1>

  <div class="card my-2">
    <div class="card-body">
      <h4>
        Basic Info
        <a class="btn btn-sm btn-secondary float-right" href="{{ url_for('tasks.edit', id=task.task_id) }}">Edit</a>
      </h4>

      <br />

      <ul>
        <li>
          Task ID: 
          <span class="badge badge-light">{{task.task_id}}</span>
        </li>
        <li>
          Pattern Model:
          {% if task.get_pattern_model() %}
            <span class="badge badge-light">{{ task.get_pattern_model() }}</span>
          {% endif %}
        </li>
        <li>
          NLP Model:
          <span class="badge badge-light">{{ active_model }}</span>
        </li>
        <li>
          Data:
          {% for fname in task._data_filenames %}
            <span class="badge badge-light">{{fname}}</span>
          {% endfor %}
        </li>
        <li>
          Annotators:
          {% for annotator in task.annotators %}
            <span class="badge badge-light">{{annotator}}</span>
          {% endfor %}
        </li>
        <li>
          Labels: 
          {% for label in task.labels %}
            <span class="badge badge-light">{{label}}</span>
          {% endfor %}
        </li>
      </ul>

    </div>
  </div>

  <div class="card my-2">
    <div class="card-body">
      <h4>
        Annotations

        {% if status_assign_jobs|length == 0 %}
          <form class='float-right' action="{{ url_for('tasks.assign', id=task.task_id) }}" method="POST">
            <button type="submit" class="btn btn-sm btn-secondary">Request more annotations from everyone</button>
          </form>
        {% endif %}

        {% for status in status_assign_jobs %}
          <div class='float-right'>
            <h6>
              Active Job: <span class="badge badge-info">{{status}}</span> <br />
              <i class='small'>Refresh page to see updates</i>
            </h6>
          </div>
        {% endfor %}
      </h4>

      <br />
      
      <div class="row">
        <div class="col">
          <ul>
            <li>
              Total outstanding requests: {{annotation_statistics['total_outstanding_requests']}}
            </li>
            <li>
              Outstanding requests for each annotator:
                <ul>
                  {% for k in annotation_statistics['n_outstanding_requests_per_user'] %}
                    <li>
                      {{k}}: {{annotation_statistics['n_outstanding_requests_per_user'][k]}}
                    </li>
                  {% endfor %}
                </ul>
            </li>
          </ul>
        </div>
        <div class="col">
          <ul>
            <li>
              Total Annotated: {{annotation_statistics['total_annotations']}}
            </li>
            <li>
              Annotated per label:
                <ul>
                  {% for k in annotation_statistics['n_annotations_per_label'] %}
                    <li>
                      {{k}}: 
                      {% for resp in annotation_statistics['n_annotations_per_label'][k] %}
                        <span class='badge badge-info'>{{resp}}</span>x{{annotation_statistics['n_annotations_per_label'][k][resp]}}
                      {% endfor %}
                    </li>
                  {% endfor %}
                </ul>
            </li>
            <li>
              Annotated by each annotator:
                <ul>
                  {% for k in annotation_statistics['n_annotations_per_user'] %}
                    <li>
                      {{k}}: {{annotation_statistics['n_annotations_per_user'][k]}}
                    </li>
                  {% endfor %}
                </ul>
            </li>
          </ul>
        </div>
      </div>
      
      <!-- <code>
        {{annotation_statistics}}
      </code> -->

    </div>
  </div>

  <div class="card my-2">
    <div class="card-body">
      <h4>
        Models
        <form class='float-right' action="{{ url_for('tasks.train', id=task.task_id) }}" method="POST">
          <button type="submit" class="btn btn-sm btn-secondary">Train new model</button>
        </form>
      </h4>

      <br />

      {% for mv in model_viewers %}
      <div class="card">
        <div class="card-body">
          <h5>{{mv}}</h5>
          
          {% set metrics = mv.get_metrics() %}

          <div class="row">
            <div class="col">
              {% for url in mv.get_plots() %}
                <!-- Note: This uses the insecure way to get a file  -->
                <img style="max-width: 400px" src="/file?f={{url}}" />
              {% endfor %}
            </div>
          </div>

          <div class="row" style="font-size: 0.8em">
            <div class="col-lg-3 col-md-6 col-sm-6">
              <h6>Train</h6>
              <pre>
                {{- metrics['train']|to_pretty_json -}}
              </pre>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6">
              <h6>Test</h6>
              <pre>
                {{- metrics['test']|to_pretty_json -}}
              </pre>
            </div>
          </div>

          <div class="row" style="font-size: 0.2em">
            <div class="col">
              Config:
              <pre>
                {{- mv.get_config()|to_pretty_json -}}
              </pre>
              Data Parser:
              <pre>
                {{- mv.get_data_parser()|to_pretty_json -}}
              </pre>
            </div>
          </div>

        </div>
      </div>
      {% endfor %}

    </div>
  </div>

{% endblock %}